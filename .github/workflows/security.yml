name: Security Audit

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install security tools
        run: |
          pip install bandit safety pip-audit

      - name: Run Bandit (SAST)
        run: |
          bandit -r src/ -f json -o bandit-results.json -ll || true
          echo "### Bandit Security Scan Results" >> $GITHUB_STEP_SUMMARY
          python -c "
          import json
          with open('bandit-results.json') as f:
              data = json.load(f)
          high = len([r for r in data['results'] if r['issue_severity'] == 'HIGH'])
          med = len([r for r in data['results'] if r['issue_severity'] == 'MEDIUM'])
          low = len([r for r in data['results'] if r['issue_severity'] == 'LOW'])
          print(f'| Severity | Count |')
          print(f'|----------|-------|')
          print(f'| High | {high} |')
          print(f'| Medium | {med} |')
          print(f'| Low | {low} |')
          " >> $GITHUB_STEP_SUMMARY

      - name: Run Safety (Dependency Check)
        run: |
          safety check -r requirements.txt --json > safety-results.json || true
          echo "### Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY

      - name: Run pip-audit
        run: |
          pip-audit -r requirements.txt --format json > pip-audit-results.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v6
        with:
          name: security-audit-reports
          path: |
            bandit-results.json
            safety-results.json
            pip-audit-results.json

      - name: Check for critical vulnerabilities
        run: |
          python -c "
          import json
          import sys
          with open('bandit-results.json') as f:
              data = json.load(f)
          high_issues = [r for r in data['results'] if r['issue_severity'] == 'HIGH']
          if len(high_issues) > 0:
              print(f'CRITICAL: {len(high_issues)} high severity issues found!')
              sys.exit(1)
          print(f'Security check passed. {len(high_issues)} high severity issues.')
          "
