input {
  # Beats input (Filebeat)
  beats {
    port => 5044
    codec => json
  }
  
  # TCP input for direct log shipping
  tcp {
    port => 5000
    codec => json
  }
  
  # HTTP input for REST API
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
  }
  
  # Add timestamp
  if ![timestamp] {
    ruby {
      code => "event.set('timestamp', Time.now.utc.iso8601)"
    }
  }
  
  # Parse log level
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }
  
  # Extract error information
  if [error_type] {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  # Add service metadata
  mutate {
    add_field => {
      "[@metadata][index_prefix]" => "pca-agent-logs"
    }
  }
  
  # Parse correlation ID
  if [correlation_id] {
    mutate {
      add_tag => [ "correlated" ]
    }
  }
  
  # Detect log patterns
  
  # API request logs
  if [request_id] and [status_code] {
    mutate {
      add_tag => [ "api_request" ]
    }
  }
  
  # Database query logs
  if [query] or [sql] {
    mutate {
      add_tag => [ "database" ]
    }
  }
  
  # LLM call logs
  if [llm_provider] or [model] {
    mutate {
      add_tag => [ "llm" ]
    }
  }
  
  # Security logs
  if [level] == "CRITICAL" or [level] == "SECURITY" {
    mutate {
      add_tag => [ "security" ]
    }
  }
  
  # Performance logs
  if [duration_ms] {
    ruby {
      code => "
        duration = event.get('duration_ms')
        if duration > 5000
          event.set('performance_issue', 'slow')
          event.tag('slow_request')
        elsif duration > 10000
          event.set('performance_issue', 'very_slow')
          event.tag('very_slow_request')
        end
      "
    }
  }
  
  # GeoIP lookup for IP addresses
  if [ip_address] {
    geoip {
      source => "ip_address"
      target => "geoip"
    }
  }
  
  # User agent parsing
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Output errors to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "pca-agent-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # Output security logs to separate index
  if "security" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "pca-agent-security-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # Debug output (optional, comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}
